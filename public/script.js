!function(){"use strict";const e={1000:"Normal Closure",1001:"Going Away",1002:"Protocol Error",1003:"Unsupported Data",1004:"No current meaning",1005:"No Status Received",1006:"Abnormal Closure",1007:"Invalid frame payload data",1008:"Policy Violation",1009:"Message too big",1010:"Missing Extension",1011:"Internal Error",1012:"Service Restart",1013:"Try Again Later",1014:"Bad Gateway",1015:"TLS Handshake"},t=["round","butt","square"],n=["source-over","destination-over","destination-out","lighten","screen","color-dodge","lighter","darken","color-burn","multiply","overlay","hard-light","soft-light","difference","exclusion","source-in","source-out","source-atop","destination-in","destination-atop","xor","copy","hue","saturation","color","luminosity"],i=n[0],a=["#000000","#ffffff"],o="#ffffff",s={values:[["#000000","#7f7f7f","#880015","#ed1c24","#ff7f27","#fff200","#22b14c","#00a2e8","#3f48cc","#a349a4"],["#ffffff","#c3c3c3","#b97a57","#ffaec9","#ffc90e","#efe4b0","#b5e61d","#99d9ea","#7092be","#c8bfe7"]],names:[["Black","Grey-50%","Dark red","Red","Orange","Yellow","Green","Turquoise","Indigo","Purple"],["White","Grey-25%","Brown","Rose","Gold","Light yellow","Lime","Light turquoise","Blue-grey","Lavender"]]},d=0,c=1,l=2,r=3,h=4,u=5,m=6,g=["pen","fill","colourPicker","select","line","rect","ellipse"],y=g.length,p=0,f=[{id:"penWidth",defaultVal:5},{id:"opacity",defaultVal:100},{id:"fillThreshold",defaultVal:32}];var I=99,E=[],v=null,k=null,w=a.slice(),B=0,x=d,b=1;const L={selected:!1,move:{},resize:{}},M=5,C=15;var R,S,T,O=L,z=new Map,P={moved:!1,outside:!1},D=[],H=new Map,N={points:[]},W=[],A=[];const F=new Map,$=document.getElementById("sessionCanvas"),U=$.getContext("2d"),V=document.getElementById("thisCanvas"),j=V.getContext("2d");var q,G;function Y(e,t,n){return n.x<e&&e<n.x+n.width&&n.y<t&&t<n.y+n.height}function J(e){const t=JSON.stringify(e);at.send(t)}function X(e){const t=document.getElementById(e);t.style.display="block",t.style.zIndex=++I}function K(e){document.getElementById(e).style.display="none",[...document.getElementsByClassName("modal")].forEach(e=>{e.style.display}),I=99}function Z(e){b+e>=p&&(b+=e,_(parseFloat(b.toFixed(2))))}function Q(e=!0){document.getElementById("canvasContainer");const t=ct.clientWidth-30,n=ct.clientHeight-30,i=t/$.width,a=n/$.height,o=Math.min(i,a);(o<b||e)&&_(o)}function _(e){b=e,document.getElementById("canvasScale").value=b,V.style.transform=`scale(${b})`,$.style.transform=`scale(${b})`,F.forEach(e=>{e.style.transform=`scale(${b})`})}function ee(){document.getElementById("canvasResizeWidth").value=$.width,document.getElementById("canvasResizeHeight").value=$.height,X("canvasResizeModal")}function te(e,t,n){const i=V.toDataURL("image/png"),a=new Map;F.forEach(e=>{a.set(e,e.toDataURL("image/png"))});var o=!1;e!=$.width&&(V.width=e,$.width=e,F.forEach(t=>{t.width=e}),o=!0),t!=$.height&&(V.height=t,$.height=t,F.forEach(e=>{e.height=t}),o=!0);const s=new Image;if(s.addEventListener("load",()=>{U.clearRect(0,0,$.width,$.height),U.drawImage(s,0,0)}),s.src=n,o){const e=new Image;e.addEventListener("load",()=>{j.drawImage(e,0,0)}),e.src=i,F.forEach(t=>{const n=t.getContext("2d"),i=new Image;i.addEventListener("load",()=>{n.drawImage(e,0,0)}),i.src=a.get(t)})}}function ne(){if(!v)return;const e=document.getElementById(v+"Input"),t=(event.clientX-e.offsetLeft)/e.clientWidth,n=Math.min(Math.max(t*e.dataset.width,e.dataset.min),e.dataset.max).toFixed(e.dataset.dplaces);ie(v,t,n)}function ie(e,t,n){document.getElementById(e+"Input").dataset.value=n,document.getElementById(e+"Value").innerHTML=n,document.getElementById(e+"Bar").style.width=Math.max(Math.min(100*t,100),0)+"%"}function ae(e,t){const n=document.getElementById(e+"Input"),i=Math.min(Math.max(parseFloat(n.dataset.value)+(t?1:-1),n.dataset.min),n.dataset.max);ie(e,i/n.dataset.width,i.toFixed(n.dataset.dplaces))}function oe(e,t){if("drawing"!==k)return!1;J({type:"add-stroke",clientId:q,x:e,y:t}),N.points.push({x:e,y:t}),de(j,N)}function se(e,t,n=!0){de(U,t,!1),e.getContext("2d").clearRect(0,0,e.width,e.height),n&&$e({type:"stroke",stroke:{...t}})}function de(e,a,o=!0){o&&e.clearRect(0,0,e.canvas.width,e.canvas.height);var s=a.points[0],d=a.points[1];e.strokeStyle=a.colour,e.lineCap=t[a.caps],e.lineWidth=a.width,e.globalAlpha=a.opacity,e.globalCompositeOperation=o?i:n[a.compOp],e.beginPath(),e.moveTo(s.x,s.y);for(var c=1;c<a.points.length;c++){const t={x:(s.x+d.x)/2,y:(s.y+d.y)/2};e.quadraticCurveTo(s.x,s.y,t.x,t.y),s=a.points[c],d=a.points[c+1]}e.lineTo(s.x,s.y),e.stroke(),e.globalAlpha=1,e.globalCompositeOperation=i}function ce(e,t=255){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16),t]:null}function le(e,t,n,i){for(var a=0;a<4;a++)if(Math.abs(e[t+a]-n[a])>i)return!1;return!0}function re(e,t,a,o,s,d,c=!0){const l=ce(a,255*s),r=$.width,h=$.height;var u=[[e,t]],m=U.getImageData(0,0,r,h).data,g=4*(t*r+e);const y=document.createElement("canvas").getContext("2d");y.canvas.width=r,y.canvas.height=h;var p=y.getImageData(0,0,r,h),f=p.data;const I=[m[g],m[g+1],m[g+2],m[g+3]],E=new Array(m.length).fill(!1);for(;u.length>0;){var v,k,w,B;for(k=(v=u.pop())[0],g=4*((w=v[1])*r+k);w-- >=0&&le(m,g,I,o);)g-=4*r;g+=4*r,w++;for(var x=B=!1;w++<h-1&&le(m,g,I,o);){for(var b=0;b<3;b++)f[g+b]=m[g+b]-(m[g+b]-l[b])*s;f[g+3]=Math.min(m[g+3]+l[3],255),E[g]=!0,k>0&&!E[g-4]&&(le(m,g-4,I,o)?x||(u.push([k-1,w]),x=!0):x&&(x=!1)),k<r-1&&!E[g+4]&&(le(m,g+4,I,o)?B||(u.push([k+1,w]),B=!0):B&&(B=!1)),g+=4*r}}y.putImageData(p,0,0),U.globalCompositeOperation=n[d],U.drawImage(y.canvas,0,0),U.globalCompositeOperation=i,c&&$e({type:"fill",x:e,y:t,colour:a,threshold:o,opacity:s,compOp:d})}function he(e,t){var n=null;return Y(e.x,e.y,{x:O.x-C/2,y:O.y-C/2,width:C,height:C})?n=t[0]:Y(e.x,e.y,{x:O.x+C/2,y:O.y-C/2,width:O.width-C,height:C})?n=t[1]:Y(e.x,e.y,{x:O.x+O.width-C/2,y:O.y-C/2,width:C,height:C})?n=t[2]:Y(e.x,e.y,{x:O.x-C/2,y:O.y+C/2,width:C,height:O.height-C})?n=t[3]:Y(e.x,e.y,{x:O.x+O.width-C/2,y:O.y+C/2,width:C,height:O.height-C})?n=t[4]:Y(e.x,e.y,{x:O.x-C/2,y:O.y+O.height-C/2,width:C,height:C})?n=t[5]:Y(e.x,e.y,{x:O.x+C/2,y:O.y+O.height-C/2,width:O.width-C,height:C})?n=t[6]:Y(e.x,e.y,{x:O.x+O.width-C/2,y:O.y+O.height-C/2,width:C,height:C})&&(n=t[7]),n}function ue(e,t){e.clearRect(0,0,V.width,V.height),t.data&&ge(e,t),e.strokeStyle="#000000",e.lineWidth=1,e.setLineDash([5,5]),e.lineDashOffset=0,e.strokeRect(t.x+.5,t.y+.5,t.width,t.height),e.strokeStyle="#ffffff",e.lineDashOffset=5,e.strokeRect(t.x+.5,t.y+.5,t.width,t.height),e.setLineDash([]),e.fillStyle="#ffffff",e.fillRect(t.x-M/2,t.y-M/2,M,M),e.fillRect(t.x+t.width/2-M/2,t.y-M/2,M,M),e.fillRect(t.x+t.width-M/2,t.y-M/2,M,M),e.fillRect(t.x-M/2,t.y+t.height/2-M/2,M,M),e.fillRect(t.x+t.width-M/2,t.y+t.height/2-M/2,M,M),e.fillRect(t.x-M/2,t.y+t.height-M/2,M,M),e.fillRect(t.x+t.width/2-M/2,t.y+t.height-M/2,M,M),e.fillRect(t.x+t.width-M/2,t.y+t.height-M/2,M,M),e.strokeStyle="#000000",e.strokeRect(t.x-M/2,t.y-M/2,M,M),e.strokeRect(t.x+t.width/2-M/2,t.y-M/2,M,M),e.strokeRect(t.x+t.width-M/2,t.y-M/2,M,M),e.strokeRect(t.x-M/2,t.y+t.height/2-M/2,M,M),e.strokeRect(t.x+t.width-M/2,t.y+t.height/2-M/2,M,M),e.strokeRect(t.x-M/2,t.y+t.height-M/2,M,M),e.strokeRect(t.x+t.width/2-M/2,t.y+t.height-M/2,M,M),e.strokeRect(t.x+t.width-M/2,t.y+t.height-M/2,M,M)}function me(){ue(j,O),document.getElementById("selectPos").innerHTML=`${O.x}, ${O.y}`,document.getElementById("selectSize").innerHTML=`${O.width}x${O.height}`,J({type:"selection-update",selection:{selected:O.selected,x:O.x,y:O.y,width:O.width,height:O.height,flipped:O.flipped},clientId:q})}function ge(e,t){const n=document.createElement("canvas");n.width=t.data.width,n.height=t.data.height,n.getContext("2d").putImageData(t.data,0,0),e.translate(t.flipped.x?t.width:0,t.flipped.y?t.height:0),e.scale(t.flipped.x?-1:1,t.flipped.y?-1:1);const i=t.x*(t.flipped.x?-1:1),a=t.y*(t.flipped.y?-1:1);e.drawImage(n,i,a,t.width,t.height),e.setTransform(1,0,0,1,0,0)}function ye(e,t,n){pe(e,t),Ie(t,n)}function pe(e,t){t.data=U.getImageData(t.x,t.y,t.width,t.height),ue(e,t)}function fe(e,t=!0){e.data&&ge(U,e),t&&$e({type:"selection-paste",selection:{x:e.x,y:e.y,width:e.width,height:e.height,flipped:e.flipped,data:{data:[...e.data.data],width:e.data.width,height:e.data.height}}})}function Ie(e,t,n=!0){U.fillStyle=t,U.fillRect(e.x,e.y,e.width,e.height),n&&$e({type:"selection-clear",selection:{x:e.x,y:e.y,width:e.width,height:e.height},colour:t})}function Ee(){O.selected&&(J({type:"selection-copy",clientId:q}),pe(j,O))}function ve(){O.selected&&(J({type:"selection-cut",colour:w[1],clientId:q}),ye(j,O,w[1]))}function ke(){O.selected&&O.data&&(J({type:"selection-paste",clientId:q}),fe(O))}function we(){J({type:"clear-selection",clientId:q}),O=L,j.clearRect(0,0,V.width,V.height)}function Be(){if(O.width<0&&(O.x+=O.width,O.width=Math.abs(O.width),O.flipped.x=!O.flipped.x,"selection-resize"===k))switch(O.resize.handle){case 0:O.resize.handle=2;break;case 2:O.resize.handle=0;break;case 3:O.resize.handle=4;break;case 4:O.resize.handle=3;break;case 5:O.resize.handle=7;break;case 7:O.resize.handle=5}if(O.height<0&&(O.y+=O.height,O.height=Math.abs(O.height),O.flipped.y=!O.flipped.y,"selection-resize"===k))switch(O.resize.handle){case 0:O.resize.handle=5;break;case 5:O.resize.handle=0;break;case 1:O.resize.handle=6;break;case 6:O.resize.handle=1;break;case 2:O.resize.handle=7;break;case 7:O.resize.handle=2}}function xe(e,a,o=!0){a.strokeStyle=e.colour,a.lineCap=t[e.caps],a.lineWidth=e.width,a.globalAlpha=e.opacity,a.globalCompositeOperation=o?i:n[e.compOp],a.beginPath(),a.moveTo(e.x0,e.y0),a.lineTo(e.x1,e.y1),a.stroke(),a.globalAlpha=1,a.globalCompositeOperation=i}function be(e,t,a=!0){const o=e.lineWidth%2!=0?e.x+.5:e.x,s=e.lineWidth%2!=0?e.y+.5:e.y;t.globalAlpha=e.opacity,t.globalCompositeOperation=a?i:n[e.compOp],e.fill&&(t.fillStyle=e.colours.fill,t.fillRect(o,s,e.width,e.height)),e.outline&&(t.strokeStyle=e.colours.outline,t.lineWidth=e.lineWidth,t.strokeRect(o,s,e.width,e.height)),t.globalAlpha=1,t.globalCompositeOperation=i}function Le(e,t,a=!0){const o=(e.x+(e.x+e.width))/2,s=(e.y+(e.y+e.height))/2,d=Math.abs(o-e.x),c=Math.abs(s-e.y);t.globalAlpha=e.opacity,t.globalCompositeOperation=a?i:n[e.compOp],e.fill&&(t.fillStyle=e.colours.fill,t.beginPath(),t.ellipse(o,s,d,c,0,0,2*Math.PI),t.fill()),e.outline&&(t.strokeStyle=e.colours.outline,t.lineWidth=e.lineWidth,t.beginPath(),t.ellipse(o,s,d,c,0,0,2*Math.PI),t.stroke()),t.globalAlpha=1,t.globalCompositeOperation=i}function Me(e){const t=function(e){return void 0===e.clientX?{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}:{x:e.clientX,y:e.clientY}}(e),n=document.getElementById("canvasContainer");return t.x+=n.scrollLeft,t.y+=n.scrollTop,{x:parseInt((t.x-(V.offsetLeft+V.clientLeft*b))/b),y:parseInt((t.y-(V.offsetTop+V.clientTop*b))/b)}}function Ce(e){const t=document.getElementById("opacityInput");var n=parseFloat(t.dataset.value);switch(n*=.01,x!==r&&we(),x){case d:N.colour=w[B],N.width=parseInt(document.getElementById("penWidthInput").dataset.value),N.caps=parseInt(document.getElementById("lineCapSelect").value),N.opacity=n,N.compOp=parseInt(document.getElementById("compositeSelect").value),J({type:"start-stroke",clientId:q,colour:N.colour,width:N.width,caps:N.caps,opacity:N.opacity,compOp:N.compOp}),k="drawing",oe(e.x,e.y);break;case c:{const t=document.getElementById("fillThresholdInput");var i=parseInt(t.dataset.value);const a=w[B],o=parseInt(document.getElementById("compositeSelect").value);J({type:"fill",x:e.x,y:e.y,colour:a,threshold:i,opacity:n,compOp:o}),re(e.x,e.y,a,i,n,o);break}case l:{const i=U.getImageData(e.x,e.y,1,1).data,d=document.getElementById("colourPickerMerge").checked;var a=[0,0,0,0];if(d){const e=ce(w[B]);for(var o=0;o<3;o++)a[o]=Math.round((i[o]+e[o])/2)}else a=i;if(Pe(function(e){return"#"+("000000"+((e[0]<<16)+(e[1]<<8)+e[2]).toString(16)).substr(-6)}(a),B),document.getElementById("colourPickerOpacity").checked){var s=i[3]/255*100;d&&(s=(s+100*n)/2),ie("opacity",s/t.dataset.width,s.toFixed(t.dataset.dplaces))}break}case r:J({type:"create-selection",clientId:q}),k="selecting",O={selected:!1,x:e.x,y:e.y,width:0,height:0,move:{},resize:{},flipped:{x:!1,y:!1}};break;case h:R={x0:e.x,y0:e.y,x1:e.x,y1:e.y,colour:w[B],width:parseInt(document.getElementById("penWidthInput").dataset.value),caps:parseInt(document.getElementById("lineCapSelect").value),opacity:n,compOp:parseInt(document.getElementById("compositeSelect").value)},k="line";break;case u:S={x:e.x,y:e.y,width:0,height:0,colours:{outline:w[B],fill:w[(B+1)%2]},lineWidth:parseInt(document.getElementById("penWidthInput").dataset.value),opacity:n,compOp:parseInt(document.getElementById("compositeSelect").value),outline:document.getElementById("shapeOutline").checked,fill:document.getElementById("shapeFill").checked},k="rect";break;case m:T={x:e.x,y:e.y,width:0,height:0,colours:{outline:w[B],fill:w[(B+1)%2]},lineWidth:parseInt(document.getElementById("penWidthInput").dataset.value),opacity:n,compOp:parseInt(document.getElementById("compositeSelect").value),outline:document.getElementById("shapeOutline").checked,fill:document.getElementById("shapeFill").checked},k="ellipse"}}function Re(e){switch(k){case"drawing":{e.preventDefault();const t=Me(e);oe(t.x,t.y),J({type:"end-stroke",clientId:q}),se(V,N);break}case"line":e.preventDefault(),J({type:"commit-line",line:R,clientId:q}),j.clearRect(0,0,V.width,V.height),xe(R,U,!1),$e({type:"line",line:R});break;case"rect":e.preventDefault(),J({type:"commit-rect",rect:S,clientId:q}),j.clearRect(0,0,V.width,V.height),be(S,U,!1),$e({type:"rect",rect:S});break;case"ellipse":e.preventDefault(),J({type:"commit-ellipse",ellipse:T,clientId:q}),j.clearRect(0,0,V.width,V.height),Le(T,U,!1),$e({type:"ellipse",ellipse:T});break;case"selecting":e.preventDefault(),O.width&&O.height?(O.selected=!0,Be()):we();break;case"selection-move":case"selection-resize":e.preventDefault()}v=null,k=null}function Se(){const e=document.createElement("a");e.style.display="none",e.href=$.toDataURL("image/png"),e.download="image.png",e.click()}function Te(e){$.width=e.width,$.height=e.height,V.width=e.width,V.height=e.height,F.forEach(t=>{t.width=e.width,t.height=e.height}),e.strokes&&(H=new Map(Object.entries(e.strokes))).forEach((e,t)=>{se(F.get(t),e,!1)}),Q(!1),U.fillStyle=o,U.fillRect(0,0,$.width,$.height),(W=e.undoActions).length?Ye():Xe(),(A=e.redoActions).length?Je():Ke();for(var t=0;t<W.length;t++)Ge(W[t]);K("retrieveModal")}function Oe(){document.getElementById("choosePicture").click()}function ze(e){const t=document.getElementById("colourPicker"),n=document.getElementById("penColour"+e).getBoundingClientRect();t.style.left=n.x+"px",t.style.top=n.y+n.height+"px",t.value=w[e],setTimeout(()=>t.click(),10)}function Pe(e,t,n=!0){if(De(e,t),w[t]=e,n){for(var i=0;i<s.length;i++)if(s[i].includes(e))return;let t=D.indexOf(e);-1!==t&&D.splice(t,1);{D.push(e);const t=document.getElementById("customColourRow").children;for(D.length>t.length&&D.shift(),i=0;i<Math.min(t.length,D.length);i++){const e=t[i],n=D[i];e.style.backgroundColor=n,e.title=`${n}\nLeft or right click to set colour`,e.onclick=(e=>Ne(e,n)),e.oncontextmenu=(e=>Ne(e,n))}}}}function De(e,t){document.getElementById("penColour"+t).style.backgroundColor=e,document.getElementById(`penColour${t}Value`).value=e}function He(e,t){var n=e.currentTarget.value;/^#?[a-f\d]{6}$/i.exec(n)&&("#"!=n.slice(0,1)&&(n="#"+n),Pe(n,t))}function Ne(e,t){var n;switch(e.button){case 0:n=0;break;case 2:n=1;break;default:return!1}e.preventDefault(),Pe(t,n,!1),w[n]=t}function We(e){x=e;for(var t=0;t<y;t++){document.getElementById(g[t]+"Btn").classList.remove("btnSelected");const e=document.getElementsByClassName(g[t]+"Settings");if(e)for(var n=0;n<e.length;n++)e[n].classList.remove("currentToolSettings")}document.getElementById(g[x]+"Btn").classList.add("btnSelected");const i=document.getElementsByClassName(g[x]+"Settings");if(i)for(n=0;n<i.length;n++)i[n].classList.add("currentToolSettings");we()}function Ae(e=!0){e&&J({type:"clear"}),U.clearRect(0,0,$.width,$.height),e&&$e({type:"clear"})}function Fe(e=!0){e&&J({type:"clear-blank"}),U.fillStyle=o,U.fillRect(0,0,$.width,$.height),e&&$e({type:"clear-blank"})}function $e(e){W.push(e),Ye(),Ke()}function Ue(){J({type:"undo"}),Ve()}function Ve(){const e=W.pop();if(e){A.push(e),Fe(!1);for(var t=0;t<W.length;t++)Ge(W[t]);Je()}else Xe();W.length||Xe()}function je(){J({type:"redo"}),qe()}function qe(){const e=A.pop();e?(W.push(e),Ge(e),Ye()):Ke(),A.length||Ke()}function Ge(e){switch(e.type){case"stroke":de(U,e.stroke,!1);break;case"fill":re(e.x,e.y,e.colour,e.threshold,e.opacity,e.compOp,!1);break;case"clear":U.clearRect(0,0,$.width,$.height);break;case"clear-blank":U.fillStyle=o,U.fillRect(0,0,$.width,$.height);break;case"selection-clear":Ie(e.selection,e.colour,!1);break;case"selection-paste":{const t={...e.selection};t.data=new ImageData(new Uint8ClampedArray(e.selection.data.data),e.selection.data.width,e.selection.data.height),fe(t,!1);break}case"line":xe(e.line,U,!1);break;case"rect":be(e.rect,U,!1);break;case"ellipse":Le(e.ellipse,U,!1)}}function Ye(){document.getElementById("undoBtn").disabled=!1}function Je(){document.getElementById("redoBtn").disabled=!1}function Xe(){W=[],document.getElementById("undoBtn").disabled=!0}function Ke(){A=[],document.getElementById("redoBtn").disabled=!0}function Ze(e,t){const n=document.createElement("textarea");n.style.position="fixed",n.style.top="-1000px",n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n);const i=document.getElementById("tooltip");i.innerHTML="Copied!",i.style.left=e.clientX+20+"px",i.style.top=e.clientY-30+"px",i.style.visibility="visible",setTimeout(()=>{i.style.visibility="hidden"},1e3)}function Qe(e,t,n){for(var i=0;i<e;i++)if(t[i]!==q){const e=document.createElement("img");e.src="img/cursor.png",e.classList.add("cursorIcon"),e.id="cursorIcon-"+t[i],document.body.appendChild(e);const n=document.createElement("canvas");n.classList.add("clientCanvas"),n.id="clientCanvas-"+t[i],n.width=$.width,n.height=$.height,n.style.transform=`scale(${b})`,document.getElementById("canvasContainer").appendChild(n),F.set(t[i],n)}_e(n)}function _e(e){var t,n;1==e?(t="is",n=""):(t="are",n="s"),document.getElementById("userBox").innerHTML=`There ${t} ${e} user${n} connected to this session.`}function et(){J({type:"leave-session"}),tt()}function tt(){document.getElementById("menuScreen").style.display="block",document.getElementById("drawScreen").style.display="none";const e=document.getElementsByClassName("cursorIcon");for(var t=0;t<e.length;t++)e[t].remove();location.hash="",document.getElementById("sessionIdInfo").innerHTML="N/A"}function nt(e){G=e,location.hash=G,document.getElementById("sessionId").innerHTML=G,document.getElementById("sessionIdInfo").innerHTML=G,document.getElementById("sessionIdCurrent").innerHTML=G}function it(){at.send("ping"+Date.now())}"WebSocket"in window||X("noWsModal");const at=new WebSocket("wss://web-draw.herokuapp.com/");at.onerror=(()=>{X("errorModal"),et()}),at.onopen=(()=>{K("connectingModal"),""!==location.hash&&J({type:"url-session",id:location.hash.slice(1)}),setInterval(()=>{if(P.moved){const e=P.x<0||P.x>$.width||P.y<0||P.y>$.height;e&&!P.outside?(J({type:"mouse-move",outside:!0,clientId:q}),P.outside=!0):e||(J({type:"mouse-move",pos:{x:P.x,y:P.y},clientId:q}),P.outside=!1),P.moved=!1}},50),setInterval(it,1e4)}),at.onclose=(t=>{et(),document.getElementById("disconnectText").innerHTML=`You were disconnected from the server.<br>Code: ${t.code} (${e[t.code]})`,X("disconnectModal")}),at.onmessage=(e=>{if("pong"===e.data.slice(0,4)){const i=Date.now()-parseInt(e.data.slice(4));document.getElementById("pingInfo").innerHTML=i+" ms",E.push(i);for(var t=0,n=0;n<E.length;n++)t+=E[n];return t=parseFloat((t/E.length).toFixed(1)),void(document.getElementById("avgPingInfo").innerHTML=t+" ms")}const i=JSON.parse(e.data);switch(i.type){case"connection-established":q=i.id,document.getElementById("clientIdInfo").innerHTML=q;break;case"start-stroke":H.set(i.clientId,{colour:i.colour,width:i.width,caps:i.caps,opacity:i.opacity,compOp:i.compOp,points:[]});break;case"add-stroke":H.get(i.clientId).points.push({x:i.x,y:i.y}),function(e){de(F.get(e).getContext("2d"),H.get(e))}(i.clientId);break;case"end-stroke":se(F.get(i.clientId),H.get(i.clientId)),H.delete(i.clientId);break;case"undo":Ve();break;case"redo":qe();break;case"fill":re(i.x,i.y,i.colour,i.threshold,i.opacity,i.compOp);break;case"clear":U.clearRect(0,0,$.width,$.height),$e({type:"clear"});break;case"clear-blank":U.fillStyle=o,U.fillRect(0,0,$.width,$.height),$e({type:"clear-blank"});break;case"import-picture":{const e=new Image;e.addEventListener("load",()=>{U.drawImage(e,0,0)}),e.src=i.image;break}case"create-selection":z.set(i.clientId,{});break;case"clear-selection":{z.delete(i.clientId);const e=F.get(i.clientId);e.getContext("2d").clearRect(0,0,e.width,e.height);break}case"selection-update":{const e=z.get(i.clientId);e.selected=i.selection.selected,e.x=i.selection.x,e.y=i.selection.y,e.width=i.selection.width,e.height=i.selection.height,e.flipped=i.selection.flipped,ue(F.get(i.clientId).getContext("2d"),e);break}case"selection-copy":pe(F.get(i.clientId).getContext("2d"),z.get(i.clientId));break;case"selection-cut":ye(F.get(i.clientId).getContext("2d"),z.get(i.clientId),i.colour);break;case"selection-paste":fe(z.get(i.clientId));break;case"selection-clear":Ie(z.get(i.clientId),i.colour);break;case"line":{const e=F.get(i.clientId).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),xe(i.line,e);break}case"commit-line":{const e=F.get(i.clientId).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),xe(i.line,U,!1),$e({type:"line",line:R});break}case"rect":{const e=F.get(i.clientId).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),be(i.rect,e);break}case"commit-rect":{const e=F.get(i.clientId).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),be(i.rect,U,!1),$e({type:"rect",rect:i.rect});break}case"ellipse":{const e=F.get(i.clientId).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),Le(i.ellipse,e);break}case"commit-ellipse":{const e=F.get(i.clientId).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),Le(i.ellipse,U,!1),$e({type:"ellipse",ellipse:i.ellipse});break}case"resize-canvas":{const e=$.toDataURL("image/png");te(i.width,i.height,e);break}case"request-canvas":{const e="drawing"===k?Object.fromEntries([...H,[q,N]]):Object.fromEntries([...H]);J({type:"response-canvas",width:$.width,height:$.height,strokes:e,undoActions:W,redoActions:A,clientId:i.clientId});break}case"response-canvas":Te(i);break;case"update-image":te(i.width,i.height,i.image);break;case"user-joined":Qe(1,i.clientIds,i.users);break;case"user-left":!function(e,t,n){for(var i=0;i<e;i++)t[i]!==q&&(document.getElementById("cursorIcon-"+t[i]).remove(),document.getElementById("clientCanvas-"+t[i]).remove(),F.delete(t[i]));_e(n)}(1,i.clientIds,i.users);break;case"mouse-move":{const e=document.getElementById("cursorIcon-"+i.clientId);if(i.outside)e.style.display="none";else{const t=i.pos.x*b+($.offsetLeft+$.clientLeft*b)-ct.scrollLeft,n=i.pos.y*b+($.offsetTop+$.clientTop*b)-ct.scrollTop;e.style.left=t+"px",e.style.top=n+"px",e.style.display="block"}break}case"password-set":K("setSessionPasswordModal");break;case"enter-password":document.getElementById("enterSessionPasswordId").innerHTML=i.id,X("enterSessionPasswordModal");break;case"wrong-password":document.getElementById("sessionWrongPassword").innerHTML=i.password,document.getElementById("sessionWrongPasswordId").innerHTML=i.id,X("sessionWrongPasswordModal");break;case"session-joined":{K("enterSessionPasswordModal"),document.getElementById("menuScreen").style.display="none",document.getElementById("drawScreen").style.display="grid",1!==i.users&&X("retrieveModal"),nt(i.id),Xe(),Ke(),Pe(a[0],0,!1),Pe(a[1],1,!1),f.forEach(e=>{const t=document.getElementById(e.id+"Input");ie(e.id,e.defaultVal/t.dataset.width,e.defaultVal.toFixed(t.dataset.dplaces))}),document.getElementById("lineCapSelect").value=0,document.getElementById("cursorPos").innerHTML="0, 0",document.getElementById("compositeSelect").value=0,document.getElementById("colourPickerMerge").checked=!1,document.getElementById("colourPickerOpacity").checked=!1,document.getElementById("shapeOutline").checked=!0,document.getElementById("shapeFill").checked=!1,We(d);const e=document.getElementById("quickColourSelect"),t=e.children;for(n=t.length-1;n>=0;n--)t[n].remove();s.values.forEach((t,n)=>{const i=document.createElement("tr");i.classList.add("quickColourRow"),t.forEach((e,t)=>{const a=document.createElement("td");a.classList.add("quickColour"),a.style.backgroundColor=e,a.title=`${s.names[n][t]}\nLeft or right click to set colour`,a.addEventListener("click",t=>Ne(t,e)),a.addEventListener("contextmenu",t=>Ne(t,e)),i.appendChild(a)}),e.appendChild(i)});const c=document.createElement("tr");for(c.classList.add("quickColourRow"),c.id="customColourRow",n=0;n<s.values[0].length;n++){const e=document.createElement("td");e.classList.add("quickColour","customColour"),c.appendChild(e)}e.appendChild(c),$.width=800,$.height=600,V.width=800,V.height=600,_(1),Q(!1),U.fillStyle=o,U.fillRect(0,0,$.width,$.height),Qe(i.users-1,i.clientIds,i.users);break}case"session-no-exist":K("enterSessionPasswordModal"),document.getElementById("sessionNoExist").innerHTML=i.id,X("sessionNoExistModal");break;case"session-already-exist":document.getElementById("sessionAlreadyExist").innerHTML=i.id,X("sessionAlreadyExistModal");break;case"leave-session":tt();break;case"session-id-changed":nt(i.id),i.clientId===q&&(K("changeSessionIdModal"),document.getElementById("sessionIdChanged").innerHTML=i.id,X("sessionIdChangedModal"));break;case"session-has-id":document.getElementById("sessionHasId").innerHTML=i.id,X("sessionHasIdModal");break;default:return void console.log("Unknown message!",i)}F.get(i.clientId)});const ot=document.getElementById("html");var st,dt;ot.addEventListener("pointermove",function(e){const t=Me(e);switch(document.getElementById("cursorPos").innerHTML=`${t.x}, ${t.y}`,ne(),k){case"drawing":e.preventDefault(),oe(t.x,t.y);break;case"line":e.preventDefault(),R.x1=t.x,R.y1=t.y,J({type:"line",line:R,clientId:q}),j.clearRect(0,0,V.width,V.height),xe(R,j);break;case"rect":e.preventDefault(),S.width=t.x-S.x,S.height=t.y-S.y,J({type:"rect",rect:S,clientId:q}),j.clearRect(0,0,V.width,V.height),be(S,j);break;case"ellipse":e.preventDefault(),T.width=t.x-T.x,T.height=t.y-T.y,J({type:"ellipse",ellipse:T,clientId:q}),j.clearRect(0,0,V.width,V.height),Le(T,j);break;case"selecting":e.preventDefault(),O.width=t.x-O.x,O.height=t.y-O.y,me();break;case"selection-move":e.preventDefault(),O.x+=t.x-O.move.x,O.y+=t.y-O.move.y,O.move.x=t.x,O.move.y=t.y,me();break;case"selection-resize":{e.preventDefault();var n=0,i=0,a=0,o=0;switch(O.resize.handle){case 0:n=a=i=o=-1;break;case 1:i=o=-1;break;case 2:i=o=-1,a=1;break;case 3:n=a=-1;break;case 4:a=1;break;case 5:n=a=-1,o=1;break;case 6:o=1;break;case 7:o=a=1}const s=t.x-O.resize.x,d=t.y-O.resize.y;O.width+=s*a,O.x-=s*n,O.height+=d*o,O.y-=d*i,O.resize.x=t.x,O.resize.y=t.y,Be(),me()}}if(O.selected){const e=he(t,["nwse-resize","ns-resize","nesw-resize","ew-resize","ew-resize","nesw-resize","ns-resize","nwse-resize"]);null!==e?V.style.cursor=e:Y(t.x,t.y,O)?V.style.cursor="move":V.style.cursor="auto"}else V.style.cursor="auto";const s=Me(e);document.getElementById("canvasContainer"),P.moved=!0,"CANVAS"!=e.target.tagName?P.x=-1:(P.x=s.x,P.y=s.y)},{passive:!1}),ot.addEventListener("pointerup",Re,{passive:!1}),ot.addEventListener("pointercancel",Re,{passive:!1}),ot.addEventListener("pointerleave",Re,{passive:!1}),ot.addEventListener("contextmenu",e=>{e.preventDefault(),e.stopPropagation()}),ot.addEventListener("click",e=>{if("LI"==e.target.tagName)return;const t=document.getElementsByClassName("menuSelected");for(var n=0;n<t.length;n++)t[n].classList.remove("menuSelected")}),ot.addEventListener("keydown",e=>{if("true"!==e.target.contentEditable&&"INPUT"!==e.target.tagName){if(e.ctrlKey)switch(e.key){case"z":Ue();break;case"Z":case"y":je();break;case"c":if(x!==r)break;Ee();break;case"x":if(x!==r)break;ve();break;case"v":if(x!==r)break;ke();break;default:return}else switch(e.key){case"F1":X("helpModal");break;case"1":_(1);break;case"2":_(2);break;case"3":_(4);break;case"4":_(8);break;case"5":_(16);break;case"=":Z(.1);break;case"-":Z(-.1);break;default:return}e.preventDefault()}}),ot.addEventListener("pointerup",()=>{clearTimeout(st),clearTimeout(dt)});const ct=document.getElementById("canvasContainer");ct.addEventListener("pointerdown",function(e){if("thisCanvas"!==e.target.id)return;if(e.button)switch(e.button){case 0:B=0;break;case 2:B=1;break;default:return}else B=0;e.preventDefault(),N.points=[];const t=Me(e);if(O.selected){const e=he(t,[0,1,2,3,4,5,6,7]);null!==e?(O.resize={handle:e,x:t.x,y:t.y},k="selection-resize"):Y(t.x,t.y,O)?(O.move={x:t.x,y:t.y},k="selection-move"):Ce(t)}else Ce(t);return!1}),ct.addEventListener("wheel",e=>{e.preventDefault(),Z(-.1*Math.sign(e.deltaY))}),document.getElementById("createSessionBtn").addEventListener("click",function(){J({type:"create-session",id:document.getElementById("sessionIdInput").value})}),document.getElementById("joinSessionBtn").addEventListener("click",function(){J({type:"join-session",id:document.getElementById("sessionIdInput").value})}),f.forEach(e=>{const t=document.getElementById(e.id+"Input");document.getElementById(e.id+"Value").addEventListener("keydown",n=>{if("Enter"===n.key){n.preventDefault();var i=parseFloat(n.target.innerHTML);"number"!=typeof i||isNaN(i)||(i>t.dataset.max?i=parseFloat(t.dataset.max):i<t.dataset.min&&(i=parseFloat(t.dataset.min)),ie(e.id,i/t.dataset.width,i.toFixed(t.dataset.dplaces)))}});const n=document.getElementById(e.id+"ValueUp"),i=document.getElementById(e.id+"ValueDown");n.addEventListener("pointerdown",t=>{ae(e.id,!0),st=setTimeout(function t(){ae(e.id,!0),st=setTimeout(t,30)},300),t.stopPropagation()}),i.addEventListener("pointerdown",t=>{ae(e.id,!1),dt=setTimeout(function t(){ae(e.id,!1),dt=setTimeout(t,30)},300),t.stopPropagation()}),t.addEventListener("pointerdown",t=>{v=e.id,ne()})});const lt=document.getElementById("colourPicker");lt.addEventListener("input",e=>{De(e.target.value,B)}),lt.addEventListener("change",e=>{Pe(e.target.value,B)});const rt=document.getElementById("quickColourSelect");rt.addEventListener("click",e=>{e.preventDefault()}),rt.addEventListener("contextmenu",e=>{e.preventDefault()}),document.getElementById("choosePicture").addEventListener("change",function(e){const t=e.currentTarget.files[0],n=new FileReader;n.onerror=(()=>{window.alert("There was an error reading the file.")}),n.onload=function(){const e=new Image;e.addEventListener("load",()=>{J({type:"import-picture",image:e.src}),U.drawImage(e,0,0)}),e.src=this.result},n.readAsDataURL(t)}),document.getElementById("chooseCanvasFile").addEventListener("change",function(e){const t=e.currentTarget.files[0],n=new FileReader;n.onerror=(()=>{window.alert("There was an error reading the file.")}),n.onload=function(){X("retrieveModal"),Te(JSON.parse(this.result))},n.readAsText(t)});const ht=document.getElementsByClassName("penColour");for(let e=0;e<ht.length;e++){const t=ht[e];t.addEventListener("click",()=>{B=e,ze(e)}),t.addEventListener("contextmenu",()=>{B=e,ze(e)})}const ut=document.getElementsByClassName("penColourValue");for(let e=0;e<ut.length;e++)ut[e].addEventListener("input",t=>He(t,e));for(let e=0;e<y;e++)document.getElementById(g[e]+"Btn").addEventListener("click",()=>We(e));const mt=document.getElementsByClassName("menuLabel");for(let e=0;e<mt.length;e++){const t=mt[e];t.addEventListener("click",()=>{const e=document.getElementsByClassName("menuSelected");for(var n=0;n<e.length;n++)e[n]!==t.parentElement&&e[n].classList.remove("menuSelected");t.parentElement.classList.toggle("menuSelected"),event.stopPropagation()})}document.getElementById("fileSaveBtn").addEventListener("click",function(){const e=document.createElement("a");e.style.display="none";const t=new Blob([JSON.stringify({width:$.width,height:$.height,undoActions:W,redoActions:A})],{type:"application/json"}),n=URL.createObjectURL(t);e.href=n,e.download="image.json",e.click(),URL.revokeObjectURL(n)}),document.getElementById("fileOpenBtn").addEventListener("click",function(){document.getElementById("chooseCanvasFile").click()}),document.getElementById("fileDownloadBtn").addEventListener("click",Se),document.getElementById("fileImportBtn").addEventListener("click",Oe),document.getElementById("editUndoBtn").addEventListener("click",Ue),document.getElementById("editRedoBtn").addEventListener("click",je),document.getElementById("editClearBtn").addEventListener("click",Fe),document.getElementById("editClearTransparentBtn").addEventListener("click",Ae),document.getElementById("editResizeBtn").addEventListener("click",ee),document.getElementById("viewResetScaleBtn").addEventListener("click",()=>_(1)),document.getElementById("viewFitScaleBtn").addEventListener("click",Q),document.getElementById("sessionChangeIdBtn").addEventListener("click",()=>X("changeSessionIdModal")),document.getElementById("sessionSetPasswordBtn").addEventListener("click",()=>X("setSessionPasswordModal")),document.getElementById("sessionLeaveBtn").addEventListener("click",et),document.getElementById("helpHelpBtn").addEventListener("click",()=>X("helpModal")),document.getElementById("helpInfoBtn").addEventListener("click",()=>X("infoModal")),document.getElementById("helpBtn").addEventListener("click",()=>X("helpModal")),document.getElementById("infoBtn").addEventListener("click",()=>X("infoModal")),document.getElementById("undoBtn").addEventListener("click",Ue),document.getElementById("redoBtn").addEventListener("click",je),document.getElementById("downloadBtn").addEventListener("click",Se),document.getElementById("importBtn").addEventListener("click",Oe);const gt=document.getElementById("clearBtn");gt.addEventListener("click",Fe),gt.addEventListener("dblclick",Ae),document.getElementById("resizeBtn").addEventListener("click",ee),document.getElementById("resetScaleBtn").addEventListener("click",()=>_(1)),document.getElementById("fitScaleBtn").addEventListener("click",Q),document.getElementById("sessionId").addEventListener("click",e=>Ze(e,G)),document.getElementById("leaveBtn").addEventListener("click",et),document.getElementById("clientIdInfo").addEventListener("click",function(e){Ze(e,this.innerHTML)}),document.getElementById("sessionIdCurrent").addEventListener("click",function(e){Ze(e,this.innerHTML)}),document.getElementById("pingInfo").addEventListener("click",function(e){Ze(e,this.innerHTML)}),document.getElementById("avgPingInfo").addEventListener("click",function(e){Ze(e,this.innerHTML)}),document.getElementById("resizeModalOkBtn").addEventListener("click",function(){K("canvasResizeModal");const e=document.getElementById("canvasResizeWidth").value,t=document.getElementById("canvasResizeHeight").value;J({type:"resize-canvas",width:e,height:t});const n=V.toDataURL("image/png"),i=$.toDataURL("image/png"),a=new Map;F.forEach(e=>{a.set(e,e.toDataURL("image/png"))});var o=!1;if(e!=$.width&&(V.width=e,$.width=e,F.forEach(t=>{t.width=e}),o=!0),t!=$.height&&(V.height=t,$.height=t,F.forEach(e=>{e.height=t}),o=!0),o){const e=new Image;e.addEventListener("load",()=>{j.drawImage(e,0,0)}),e.src=n,U.fillStyle=w[1],U.fillRect(0,0,$.width,$.height);const t=new Image;t.addEventListener("load",()=>{U.drawImage(t,0,0)}),t.src=i,F.forEach(t=>{const n=t.getContext("2d"),i=new Image;i.addEventListener("load",()=>{n.drawImage(e,0,0)}),i.src=a.get(t)})}}),document.getElementById("resizeModalCancelBtn").addEventListener("click",()=>K("canvasResizeModal")),document.getElementById("canvasResizeModal").addEventListener("keydown",()=>{"Enter"===event.key&&document.getElementById("resizeModalOkBtn").click()}),document.getElementById("helpModalDoneBtn").addEventListener("click",()=>K("helpModal")),document.getElementById("infoModalDoneBtn").addEventListener("click",()=>K("infoModal")),document.getElementById("sessionIdInfo").addEventListener("click",function(e){Ze(e,this.innerHTML)}),document.getElementById("sessionIdModalChangeBtn").addEventListener("click",function(){J({type:"session-id",id:document.getElementById("sessionIdNew").value})}),document.getElementById("sessionIdModalCancelBtn").addEventListener("click",()=>K("changeSessionIdModal")),document.getElementById("sessionIdChangedModalOkBtn").addEventListener("click",()=>K("sessionIdChangedModal")),document.getElementById("sessionHasIdModalOkBtn").addEventListener("click",()=>K("sessionHasIdModal")),document.getElementById("setSessionPasswordModalRemoveBtn").addEventListener("click",()=>{J({type:"session-password",password:null})}),document.getElementById("setSessionPasswordModalSetBtn").addEventListener("click",function(){J({type:"session-password",password:document.getElementById("sessionPasswordNew").value})}),document.getElementById("setSessionPasswordModalCancelBtn").addEventListener("click",()=>K("setSessionPasswordModal")),document.getElementById("enterSessionPasswordModalJoinBtn").addEventListener("click",function(){J({type:"enter-password",password:document.getElementById("enterSessionPassword").value,id:document.getElementById("enterSessionPasswordId").innerHTML})}),document.getElementById("enterSessionPasswordModalCancelBtn").addEventListener("click",()=>K("enterSessionPasswordModal")),document.getElementById("sessionWrongPasswordModalOkBtn").addEventListener("click",()=>K("sessionWrongPasswordModal")),document.getElementById("pingBtn").addEventListener("click",it),document.getElementById("appInfoLink").addEventListener("click",()=>X("appInfoModal")),document.getElementById("appInfoModalDoneBtn").addEventListener("click",()=>K("appInfoModal")),document.getElementById("errorModalOkBtn").addEventListener("click",()=>K("errorModal")),document.getElementById("disconnectModalOkBtn").addEventListener("click",()=>K("disconnectModal")),document.getElementById("sessionNoExistModalOkBtn").addEventListener("click",()=>K("sessionNoExistModal")),document.getElementById("sessionAlreadyExistModalOkBtn").addEventListener("click",()=>K("sessionAlreadyExistModal")),document.getElementById("canvasScale").addEventListener("input",function(e){_(parseFloat(e.currentTarget.value))}),document.getElementById("selectCopyBtn").addEventListener("click",Ee),document.getElementById("selectCutBtn").addEventListener("click",ve),document.getElementById("selectPasteBtn").addEventListener("click",ke),document.getElementById("selectClearBtn").addEventListener("click",()=>{J({type:"selection-clear",colour:w[1],clientId:q}),Ie(O,w[1])}),window.addEventListener("beforeunload",()=>{at.onclose=et,at.close(1e3)})}();